generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  CLIENT
}

enum PackageUnit {
  HOUR
  DAY
  FIXED_MINUTES
}

enum ServiceUnit {
  PER_BOOKING
  PER_HOUR
  PER_DAY
  FIXED
}

model User {
  id               String   @id @default(uuid())
  email            String   @unique
  name             String
  password         String
  role             UserRole @default(CLIENT)
  stripeCustomerId String?  @unique @map("stripe_customer_id")
  createdAt        DateTime @default(now()) @map("created_at")

  bookings      Booking[]
  subscriptions Subscription[]
  ledgerEntries CreditLedger[]
  invoices      Invoice[]

  @@map("users")
}

model StudioRoom {
  id               String   @id @default(uuid())
  name             String
  slug             String   @unique
  description      String
  capacity         Int
  equipmentSummary String   @default("") @map("equipment_summary")
  coverImageUrl    String?  @map("cover_image_url")
  isActive         Boolean  @default(true) @map("is_active")
  
  // Legacy fields kept for backward compatibility if needed, or can be removed if data migration is done
  hourlyRate       Decimal? @map("hourly_rate") 
  imageUrl         String?  @map("image_url")
  type             String?  // 'recording', 'podcast', 'photography'

  createdAt        DateTime @default(now()) @map("created_at")

  bookings Booking[]
  packages Package[]

  @@map("studio_rooms")
}

model Package {
  id              String      @id @default(uuid())
  slug            String      @unique
  name            String
  description     String
  price           Decimal     // Legacy Decimal
  durationMinutes Int         @map("duration_minutes")
  active          Boolean     @default(true)
  studioRoomId    String?     @map("studio_room_id")
  
  // New flexible fields
  unit            PackageUnit @default(HOUR)
  minQuantity     Int         @default(1) @map("min_quantity")
  maxQuantity     Int         @default(1) @map("max_quantity")
  stepQuantity    Int         @default(1) @map("step_quantity")
  pricePerUnitMinor Int       @default(0) @map("price_per_unit_minor")
  isActive        Boolean     @default(true) @map("is_active")
  
  // Legacy fields
  credits         Int         @default(0)
  validityDays    Int         @default(30) @map("validity_days")

  studioRoom      StudioRoom? @relation(fields: [studioRoomId], references: [id])
  
  @@map("packages")
}

model Service {
  id          String      @id @default(uuid())
  slug        String      @unique
  name        String
  description String?
  price       Decimal     // Legacy
  active      Boolean     @default(true)
  
  // New flexible fields
  category    ServiceCategory @default(EXTRA)
  unit        ServiceUnit     @default(PER_BOOKING)
  minQuantity Int             @default(1) @map("min_quantity")
  maxQuantity Int             @default(1) @map("max_quantity")
  stepQuantity Int            @default(1) @map("step_quantity")
  priceMinor  Int             @default(0) @map("price_minor")
  isActive    Boolean         @default(true) @map("is_active")
  iconAssetKey String?        @map("icon_asset_key")

  // Legacy
  durationMin Int?    @default(0) @map("duration_min")

  bookingLineItems BookingLineItem[]

  @@map("services")
}

enum ServiceCategory {
  RECORDING
  EDITING
  EXTRA
}

model Plan {
  id              String  @id @default(uuid())
  name            String
  slug            String  @unique
  monthlyPrice    Int     @map("monthly_price") // Minor units (e.g., 150050 for 1500.50 AED)
  includedCredits Int     @map("included_credits") // Hours per month
  description     String?
  isActive        Boolean @default(true) @map("is_active")

  subscriptions Subscription[]

  @@map("plans")
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @map("user_id")
  planId               String             @map("plan_id")
  status               SubscriptionStatus
  stripeCustomerId     String?            @map("stripe_customer_id")
  stripeSubscriptionId String?            @unique @map("stripe_subscription_id")
  currentPeriodStart   DateTime?          @map("current_period_start")
  currentPeriodEnd     DateTime           @map("current_period_end")
  latestInvoiceId      String?            @map("latest_invoice_id")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])
  plan Plan @relation(fields: [planId], references: [id])

  invoices Invoice[]

  @@map("subscriptions")
}

enum TransactionType {
  PURCHASE
  BOOKING
  ADJUSTMENT
  SUBSCRIPTION
  GRANT
}

model CreditLedger {
  id              String          @id @default(uuid())
  userId          String          @map("user_id")
  bookingId       String?         @map("booking_id")
  amount          Int             // Positive for credit, negative for debit (acts as changeMinutes)
  transactionType TransactionType @map("transaction_type") // Acts as reason: GRANT, CONSUME, ADJUST
  referenceId     String?         @map("reference_id") // ID of related booking/invoice
  description     String?
  createdAt       DateTime        @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("credit_ledger")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  PAID
  COMPLETED
}

model Booking {
  id                      String        @id @default(uuid())
  userId                  String        @map("user_id")
  roomId                  String        @map("room_id")
  startTime               DateTime      @map("start_time")
  endTime                 DateTime      @map("end_time")
  status                  BookingStatus @default(PENDING)
  totalPrice              Decimal       @map("total_price")
  totalPriceAedSnapshot   Decimal       @default(0) @map("total_price_aed_snapshot")
  timeZone                String        @default("Asia/Dubai") @map("time_zone")
  usedCreditMinutes       Int           @default(0) @map("used_credit_minutes")
  totalPriceMinorSnapshot Int           @default(0) @map("total_price_minor_snapshot")
  createdAt               DateTime      @default(now()) @map("created_at")

  stripeCheckoutSessionId String?   @unique @map("stripe_checkout_session_id")
  stripePaymentIntentId   String?   @unique @map("stripe_payment_intent_id")
  paidAt                  DateTime? @map("paid_at")

  user User       @relation(fields: [userId], references: [id])
  room StudioRoom @relation(fields: [roomId], references: [id])

  lineItems BookingLineItem[]
  invoice   Invoice?
  assets    Asset[]

  @@index([roomId, startTime, endTime])
  @@map("bookings")
}

model BookingLineItem {
  id                    String  @id @default(uuid())
  bookingId             String  @map("booking_id")
  serviceId             String? @map("service_id")
  priceAtBooking        Decimal @map("price_at_booking")
  nameSnapshot          String  @map("name_snapshot")
  unitPriceAedSnapshot  Decimal @map("unit_price_aed_snapshot")
  totalPriceAedSnapshot Decimal @map("total_price_aed_snapshot")
  quantity              Int?    @default(1)

  unitPriceMinorSnapshot  Int @default(0) @map("unit_price_minor_snapshot")
  totalPriceMinorSnapshot Int @default(0) @map("total_price_minor_snapshot")

  booking Booking  @relation(fields: [bookingId], references: [id])
  service Service? @relation(fields: [serviceId], references: [id])

  @@map("booking_line_items")
}

enum InvoiceStatus {
  PAID
  UNPAID
  VOID
}

model Invoice {
  id                    String        @id @default(uuid())
  userId                String        @map("user_id")
  bookingId             String?       @unique @map("booking_id")
  subscriptionId        String?       @map("subscription_id")
  amount                Decimal
  status                InvoiceStatus
  pdfUrl                String?       @map("pdf_url")
  stripePaymentIntentId String?       @unique @map("stripe_payment_intent_id")
  createdAt             DateTime      @default(now()) @map("created_at")

  user         User          @relation(fields: [userId], references: [id])
  booking      Booking?      @relation(fields: [bookingId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@map("invoices")
}

enum AssetKind {
  RAW
  EDIT_V1
  FINAL
}

model Asset {
  id         String    @id @default(uuid())
  bookingId  String    @map("booking_id")
  kind       AssetKind
  filename   String
  mimeType   String    @map("mime_type")
  sizeBytes  Int       @map("size_bytes")
  storageKey String    @unique @map("storage_key")
  createdAt  DateTime  @default(now()) @map("created_at")

  booking    Booking   @relation(fields: [bookingId], references: [id])

  @@map("assets")
}

model StripeEventProcessed {
  id        String   @id
  createdAt DateTime @default(now()) @map("created_at")

  @@map("stripe_events_processed")
}

model AuditLog {
  id          String   @id @default(uuid())
  actorUserId String?  @map("actor_user_id")
  actorEmail  String?  @map("actor_email")
  actorRole   String?  @map("actor_role")
  action      String
  entity      String?
  entityId    String?  @map("entity_id")
  ip          String?
  userAgent   String?  @map("user_agent")
  requestId   String?  @map("request_id")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([actorUserId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}
